name: Price Tracker

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

jobs:
  track-prices:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 lxml
        sudo apt-get update && sudo apt-get install -y jq

    - name: Validate tokens
      env:
        PUSHBULLET_TOKEN: ${{ secrets.PUSHBULLET_TOKEN }}
      run: |
        # Test Pushbullet token
        if [ -n "$PUSHBULLET_TOKEN" ]; then
          echo "✅ Pushbullet token found"
          curl -s -H "Access-Token: $PUSHBULLET_TOKEN" https://api.pushbullet.com/v2/users/me | jq -r '.email' && echo "Pushbullet token valid" || echo "Pushbullet token invalid"
        else
          echo "❌ Pushbullet token missing"
        fi

    - name: Run price tracker with Safety Check
      env:
        PUSHBULLET_TOKEN: ${{ secrets.PUSHBULLET_TOKEN }}
      run: |
        # 1. Create backup of current config
        cp price_tracker_config.json price_tracker_config.backup.json
        
        # 2. Run the tracker (this will send Pushbullet notifications if configured)
        python price_tracker_universal.py
        
        # 3. Safety Check: Verify product list wasn't deleted/corrupted
        python safety_check_inline.py
        
        # 4. Cleanup backup
        rm price_tracker_config.backup.json

    - name: Send Pushbullet notification
      env:
        PUSHBULLET_TOKEN: ${{ secrets.PUSHBULLET_TOKEN }}
      run: |
        # Send completion notification
        if [ -n "$PUSHBULLET_TOKEN" ]; then
          echo "Sending completion notification via Pushbullet..."
          curl -s -X POST https://api.pushbullet.com/v2/pushes \
            -H "Access-Token: $PUSHBULLET_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "note",
              "title": "Price Tracker Complete",
              "body": "Price tracking run completed successfully. Check GitHub for any price changes."
            }' && echo "✅ Pushbullet notification sent" || echo "❌ Failed to send Pushbullet notification"
        else
          echo "No Pushbullet token configured, skipping notification"
        fi

    - name: Commit changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add price_tracker_config.json
        
        # Only commit if there are actual changes
        if git diff --staged --quiet; then
          echo "No price changes to save."
        else
          git commit -m "Update prices [skip ci]"
          git push
        fi
